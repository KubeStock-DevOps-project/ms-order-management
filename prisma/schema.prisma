// Prisma schema reflecting existing SQL tables

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Order {
  id                    String      @id @db.Uuid
  reference             String?
  status                String
  customerId            String?     @map("customer_id")
  salesChannel          String?     @map("sales_channel")
  totals                Json?       @db.JsonB
  shippingAddress       Json?       @map("shipping_address") @db.JsonB
  billingInfo           Json?       @map("billing_info") @db.JsonB
  notes                 String?
  preferredWarehouseId  String?     @map("preferred_warehouse_id") @db.Uuid
  reservationId         String?     @map("reservation_id") @db.Uuid
  version               Int         @default(1)
  createdAt             DateTime    @map("created_at") @default(now())
  updatedAt             DateTime    @map("updated_at") @updatedAt
  deleted               Boolean     @map("_deleted") @default(false)

  items                 OrderItem[]
  audits                AuditEntry[]
  idempotencyKeys       IdempotencyKey[]

  @@map("orders")
  @@index([createdAt], name: "idx_orders_created_at")
  @@index([status], name: "idx_orders_status")
}

model OrderItem {
  id          String   @id @db.Uuid
  orderId     String   @db.Uuid @map("order_id")
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  sku         String
  productId   String?  @db.Uuid @map("product_id")
  quantity    Int
  unitPrice   Decimal  @map("unit_price") @db.Decimal(12, 2)
  totalPrice  Decimal  @map("total_price") @db.Decimal(14, 2)
  meta        Json?    @db.JsonB

  @@map("order_items")
  @@index([orderId], name: "idx_order_items_order_id")
}

model Webhook {
  id         String   @id @db.Uuid
  url        String
  events     Json     @db.JsonB
  secret     String
  createdAt  DateTime @map("created_at") @default(now())

  @@map("webhooks")
}

model AuditEntry {
  id         String   @id @db.Uuid
  orderId    String   @db.Uuid @map("order_id")
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  actor      String?
  action     String?
  details    Json?    @db.JsonB
  timestamp  DateTime @default(now())

  @@map("audit_entries")
  @@index([orderId], name: "idx_audit_entries_order_id")
}

model IdempotencyKey {
  id        Int     @id @default(autoincrement())
  key       String  @unique
  orderId   String  @db.Uuid @map("order_id")
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  createdAt DateTime @map("created_at") @default(now())

  @@map("idempotency_keys")
}
